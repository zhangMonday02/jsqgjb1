name: 嘉立创全自动并发抢购

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    # 每天 UTC 0点 (北京时间 08:00) 运行
    - cron: '00 00 * * *'

jobs:
  # 第一阶段：解析配置
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 读取配置生成矩阵
        id: set-matrix
        run: |
          # 使用 jq 将 json 文件压缩为单行字符串，用于传递给下一个任务
          JSON=$(jq -c . ./config.json)
          echo "matrix=$JSON" >> $GITHUB_OUTPUT

  # 第二阶段：并发执行 (根据账号数量自动并行)
  seckill-attack:
    needs: prepare-matrix
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false # 关键：一个账号失败不影响其他账号
      max-parallel: 20 # GitHub 免费版限制并发数，防止排队过长
      matrix:
        account: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    name: 抢购-${{ matrix.account.username }}
    
    steps:
      - name: '检出代码'
        uses: actions/checkout@v3
        
      - name: '设置Python环境'
        uses: actions/setup-python@v5
        with:
          python-version: 3.9
          
      - name: '设置时区'
        run: sudo timedatectl set-timezone Asia/Shanghai
          
      - name: '安装依赖'
        run: |
          pip install --upgrade pip
          pip install pytz
          pip install requests==2.26.0
          pip install lxml==4.6.5
          pip install selenium==3.141.0
          pip install numpy==1.19.5
          pip install retrying==1.3.3
          pip install wheel==0.37.1
          
      - name: '准备Chrome驱动'
        uses: nanasess/setup-chromedriver@v2
        
      - name: '执行抢购'
        env:
          # 也可以在这里把参数映射为环境变量
          USER: ${{ matrix.account.username }}
          PWD: ${{ matrix.account.password }}
          SKU: ${{ matrix.account.sku }}
          ACT_ID: ${{ matrix.account.activity_id }}
        run: |
          echo "正在启动任务：用户 $USER 目标 $SKU"
          # 将参数传递给 Python 脚本
          python ./jlc.py "$USER" "$PWD" "$SKU" "$ACT_ID"
